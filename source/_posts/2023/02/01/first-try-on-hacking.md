---
title: 网络"推理"初尝试
tags:
  - Brainstorm
  - Hacking
categories:
  - Coding
date: 2023-02-01 23:50:08
---


# 起因

因为那天要上网找学习资料，所以翻了不少资料网站。  
大部份网站都需要会员，但却有一个网站，提供了很多免费的资源，但一些答案是需要付费才能查看答案的。  

这个网站，比较特别，说输入购买和查看都不需要注册，直接输入手机号即可。

点进请求，发现是一个很简单的post请求，查询条件是个很基础的结构（类似这样⬇️）

```json5
{
  "code": 123, // 这个字段是读取用户输入的"手机号"
  "catId": 1, // 随页面带过来的
  "id": 1 // 随页面带过来的
}
```
这种结构很明显就看出来，`catId`和`id`是索引这个页面内容的关键字段
- `catId` 应该是分类的id
- `id` 则是对应文章的id

这是脑子里面有一个大胆的想法就冒出来了

# 阴差阳错的第一次思路

因为现在欠缺的仅仅是`code`字段而已，是否穷举就能把码试出来了呢？

心动不如行动，正好想练习一下Go，于是就拿Go来写一个简单请求了

但是代码不是很成功，一直报错，`接口返回了SQL的报错信息`，一看那几个值压根就没传过去呀！

检查了一下发现是`http.Post`和`http.PostForm`的区别，前者的传参会出现在url上，而接口接受的body里面的json，因此后端没能接收到参数

慢着？接口的响应竟然清晰地把SQL显示在了我面前，岂不是说明对方的后端服务是没有做什么防御措施？

# 方向明确的第二次尝试

当知道对方服务器对SQL注入没有防备时，觉得机会来了。毕竟穷举法效率低，一不小心还会DDOS服务器被察觉。

首先对方的SQL结构是这样的：
```sql
SELECT * FROM xxx.xxx WHERE code = '?' AND catId = ? AND id = ? AND other_condition = xxx ORDER BY id DESC LIMIT 1;
```
可以注入的点位就是接口展示的那几个。

首先我尝试了拼接SQL。

就是传参的时候加上`;`，看看能否拼接一个插入语句进去，但是一直报错说SQL不正确

跟着就继续翻阅资料。

发现了一种神奇的方式，那就是通过注解把后边的SQL给取消掉！

于是在最后的一个参数上，拼接了`OR 1 = 1 #`，成功了！

```json5
{
  "code": 123,
  "catId": 1,
  "id": '1 OR 1 = 1 #' // 传参改成了这样
}
```

```sql
# 构成的SQL长这样
SELECT * FROM xxx.xxx WHERE code = '123' AND catId = 1 AND id = 1 OR 1 = 1 # AND other_condition = xxx ORDER BY id DESC LIMIT 1; 
```

借此，成功获取到了隐藏内容！

# 优化

因为虽然通过接口拿到了隐藏内容，但这样去下载还是不太方便。如果能在页面上按照原有的逻辑，把内容显示出来，岂不妙哉？

于是我试着直接修改页面上的javascript，把id赋值的地方改为上面的内容，但执行的时候却失败了，没有任何变化。

这里就涉及到了一个知识点，所有的代码都在页面加载的时候就写进了内存了。因此后面的改变并不会影响到原有代码的执行。

但这还不简单吗？

直接打个断点，把内存的值给修改掉不就得了！

事实证明，断点时的确是能够改值的。

至此，一次简单的"黑客"就完成了

# 反思

如果是我本人的网站，安全上绝对不能做得如此漏洞百出！

个人感觉至少有三点可以进行优化：
- 业务上，购买等请求要带上cookie，追踪操作请求
- 业务上，对外暴露的接口，不要把核心信息明文暴露出来，请求内容使用非对称加密并要加上时间戳验证
- 实现上，使用现代web框架，避免SQL注入
